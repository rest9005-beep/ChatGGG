<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OfflineTube ‚Äî YouTube clone</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f0f10;
      --panel: #16181c;
      --panel-2: #1f2229;
      --text: #f5f5f7;
      --muted: #b6bbc5;
      --accent: #ff4d67;
      --accent-2: #5aa9ff;
      --green: #42d392;
      --border: #2b2f36;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button, input, select, textarea {
      font: inherit;
      color: inherit;
      background: transparent;
      border: none;
      outline: none;
    }

    .app {
      display: grid;
      grid-template-columns: 240px 1fr;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
    }

    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 20px;
    }

    .logo-badge {
      width: 36px;
      height: 36px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, #ff4d67, #ff9f5a);
      border-radius: 12px;
      font-weight: 700;
      color: #111;
    }

    .search-bar {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--panel-2);
      padding: 8px 12px;
      border-radius: 999px;
      margin: 0 24px;
      border: 1px solid transparent;
    }

    .search-bar input {
      flex: 1;
    }

    .search-bar:focus-within {
      border-color: var(--accent-2);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn {
      padding: 10px 16px;
      background: var(--panel-2);
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: 0.2s ease;
    }

    .btn:hover {
      border-color: var(--accent-2);
      color: var(--accent-2);
    }

    .btn.primary {
      background: var(--accent);
      border-color: transparent;
      color: #111;
      font-weight: 600;
    }

    .btn.primary:hover {
      filter: brightness(1.1);
      color: #111;
    }

    .btn.ghost {
      background: transparent;
    }

    .sidebar {
      padding: 24px;
      border-right: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .nav-link.active, .nav-link:hover {
      background: var(--panel-2);
      color: var(--accent-2);
    }

    .content {
      padding: 24px 32px 64px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
    }

    .video-card {
      background: var(--panel);
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .video-card:hover {
      transform: translateY(-4px);
    }

    .video-thumb {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }

    .video-info {
      padding: 12px;
      display: grid;
      gap: 6px;
    }

    .video-meta {
      color: var(--muted);
      font-size: 12px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      font-size: 12px;
      color: var(--muted);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .filters select, .filters input {
      background: var(--panel-2);
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .watch-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    .player {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid var(--border);
    }

    .player video, .player iframe {
      width: 100%;
      border-radius: 12px;
      background: #000;
      min-height: 360px;
    }

    .player-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    .comment-box, .comment-list {
      margin-top: 20px;
      background: var(--panel);
      border-radius: var(--radius);
      padding: 16px;
      border: 1px solid var(--border);
    }

    .comment {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .comment:last-child {
      border-bottom: none;
    }

    .comment .meta {
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }

    .comment-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .channel-hero {
      background: linear-gradient(135deg, rgba(90,169,255,0.25), rgba(255,77,103,0.25));
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin: 16px 0;
    }

    .tab {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      background: var(--panel-2);
    }

    .tab.active {
      border-color: var(--accent-2);
      color: var(--accent-2);
    }

    .list {
      display: grid;
      gap: 12px;
    }

    .list-item {
      background: var(--panel);
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--panel);
      padding: 24px;
      border-radius: 16px;
      width: min(520px, 90vw);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: grid;
      gap: 16px;
    }

    .form-field {
      display: grid;
      gap: 6px;
    }

    .form-field input, .form-field textarea, .form-field select {
      background: var(--panel-2);
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--panel-2);
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display: none;
    }

    .toast.show {
      display: block;
    }

    .badge {
      background: var(--accent-2);
      color: #111;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
    }

    .muted {
      color: var(--muted);
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 960px) {
      .app {
        grid-template-columns: 1fr;
      }
      .sidebar {
        flex-direction: row;
        overflow-x: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      .nav-link {
        white-space: nowrap;
      }
      .watch-layout {
        grid-template-columns: 1fr;
      }
      header {
        flex-wrap: wrap;
        gap: 12px;
      }
      .search-bar {
        margin: 0;
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="logo">
        <span class="logo-badge">‚ñ∂</span>
        <span>OfflineTube</span>
      </div>
      <div class="search-bar">
        <input type="text" id="global-search" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ, –∫–∞–Ω–∞–ª–æ–≤, —Ç–µ–≥–æ–≤">
        <button class="btn ghost" id="search-btn">–ü–æ–∏—Å–∫</button>
      </div>
      <div class="header-actions">
        <button class="btn" id="upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <button class="btn" id="notifications-btn">üîî <span id="notif-count" class="badge hidden">0</span></button>
        <button class="btn" id="auth-btn">–í–æ–π—Ç–∏</button>
      </div>
    </header>

    <aside class="sidebar">
      <div class="nav-link active" data-route="home">üè† –ì–ª–∞–≤–Ω–∞—è</div>
      <div class="nav-link" data-route="subscriptions">üì∫ –ü–æ–¥–ø–∏—Å–∫–∏</div>
      <div class="nav-link" data-route="playlists">üéµ –ü–ª–µ–π–ª–∏—Å—Ç—ã</div>
      <div class="nav-link" data-route="history">üïí –ò—Å—Ç–æ—Ä–∏—è</div>
    </aside>

    <main class="content">
      <section id="home" class="section active">
        <div class="section-title">
          <h2>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
          <div class="filters">
            <select id="home-sort">
              <option value="new">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
              <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
            </select>
          </div>
        </div>
        <div id="home-grid" class="video-grid"></div>
        <div id="home-load" class="btn ghost" style="margin-top:16px;">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</div>
      </section>

      <section id="watch" class="section">
        <div class="watch-layout">
          <div>
            <div class="player" id="player-box"></div>
            <div class="comment-box">
              <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
              <div class="filters">
                <select id="comment-sort">
                  <option value="new">–ù–æ–≤—ã–µ</option>
                  <option value="top">–¢–æ–ø</option>
                </select>
              </div>
              <div class="form-field">
                <textarea id="comment-input" rows="3" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                <button class="btn primary" id="comment-submit">–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            </div>
            <div class="comment-list" id="comment-list"></div>
          </div>
          <div>
            <h3>–°–ª–µ–¥—É—é—â–µ–µ</h3>
            <div id="recommendations" class="list"></div>
          </div>
        </div>
      </section>

      <section id="channel" class="section">
        <div class="channel-hero" id="channel-hero"></div>
        <div class="tabs">
          <div class="tab active" data-tab="videos">–í–∏–¥–µ–æ</div>
          <div class="tab" data-tab="playlists">–ü–ª–µ–π–ª–∏—Å—Ç—ã</div>
          <div class="tab" data-tab="about">–û –∫–∞–Ω–∞–ª–µ</div>
        </div>
        <div id="channel-content"></div>
      </section>

      <section id="subscriptions" class="section">
        <div class="section-title">
          <h2>–ü–æ–¥–ø–∏—Å–∫–∏</h2>
        </div>
        <div id="subscriptions-grid" class="video-grid"></div>
      </section>

      <section id="playlists" class="section">
        <div class="section-title">
          <h2>–ü–ª–µ–π–ª–∏—Å—Ç—ã</h2>
          <button class="btn" id="playlist-create">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div id="playlist-list" class="list"></div>
      </section>

      <section id="history" class="section">
        <div class="section-title">
          <h2>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</h2>
          <button class="btn" id="history-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="history-list" class="list"></div>
      </section>

      <section id="search" class="section">
        <div class="section-title">
          <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
        </div>
        <div class="filters">
          <select id="search-date">
            <option value="all">–í—Å–µ –¥–∞—Ç—ã</option>
            <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
            <option value="30">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
          </select>
          <select id="search-sort">
            <option value="relevance">–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å</option>
            <option value="new">–ù–æ–≤—ã–µ</option>
            <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
          </select>
        </div>
        <div id="search-grid" class="video-grid"></div>
      </section>
    </main>
  </div>

  <div class="modal" id="auth-modal">
    <div class="modal-content">
      <h3 id="auth-title">–í—Ö–æ–¥</h3>
      <div class="form-field">
        <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <input type="text" id="auth-username">
      </div>
      <div class="form-field">
        <label>Email</label>
        <input type="email" id="auth-email">
      </div>
      <div class="form-field">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="auth-password">
      </div>
      <div class="filters">
        <button class="btn" id="auth-toggle">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button class="btn primary" id="auth-submit">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal" id="upload-modal">
    <div class="modal-content">
      <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</h3>
      <div class="form-field">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="upload-title">
      </div>
      <div class="form-field">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="upload-description" rows="3"></textarea>
      </div>
      <div class="form-field">
        <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
        <input type="text" id="upload-tags">
      </div>
      <div class="form-field">
        <label>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</label>
        <select id="upload-privacy">
          <option value="public">Public</option>
          <option value="unlisted">Unlisted</option>
          <option value="private">Private</option>
        </select>
      </div>
      <div class="form-field">
        <label>–í–∏–¥–µ–æ —Ñ–∞–π–ª</label>
        <input type="file" id="upload-file" accept="video/*">
      </div>
      <div class="form-field">
        <label>–∏–ª–∏ URL –≤–∏–¥–µ–æ</label>
        <input type="url" id="upload-url" placeholder="https://">
      </div>
      <div class="filters">
        <button class="btn" id="upload-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn primary" id="upload-submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal" id="playlist-modal">
    <div class="modal-content">
      <h3>–ù–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</h3>
      <div class="form-field">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="playlist-name">
      </div>
      <div class="form-field">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="playlist-description" rows="3"></textarea>
      </div>
      <div class="filters">
        <button class="btn" id="playlist-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn primary" id="playlist-submit">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal" id="notifications-modal">
    <div class="modal-content">
      <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
      <div id="notifications-list" class="list"></div>
      <button class="btn" id="notifications-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const STORAGE_KEY = 'offlineTubeStore';
    const inMemoryVideoUrls = new Map();

    const generateId = () => {
      if (window.crypto && crypto.getRandomValues) {
        const array = new Uint32Array(4);
        crypto.getRandomValues(array);
        return Array.from(array, part => part.toString(16).padStart(8, '0')).join('-');
      }
      return `id-${Math.random().toString(36).slice(2)}-${Date.now()}`;
    };

    const pseudoHash = (text) => {
      let hash = 0x811c9dc5;
      for (let i = 0; i < text.length; i += 1) {
        hash ^= text.charCodeAt(i);
        hash = (hash * 0x01000193) >>> 0;
      }
      return hash.toString(16).padStart(8, '0');
    };

    const store = {
      users: [],
      sessions: [],
      videos: [],
      comments: [],
      likes: [],
      subscriptions: [],
      playlists: [],
      watchHistory: [],
      notifications: [],
      currentSessionId: null
    };

    const saveStore = () => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
    };

    const loadStore = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        seedStore();
        return;
      }
      try {
        const data = JSON.parse(raw);
        Object.assign(store, data);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞', error);
        seedStore();
      }
    };

    const seedStore = () => {
      const now = Date.now();
      const user1 = { id: generateId(), username: 'demo', email: 'demo@offline.tube', passwordHash: pseudoHash('demo123'), channelName: 'Demo Channel', about: '–ö–∞–Ω–∞–ª –æ –¥–µ–º–æ –∫–æ–Ω—Ç–µ–Ω—Ç–µ.' };
      const user2 = { id: generateId(), username: 'travelgirl', email: 'travel@offline.tube', passwordHash: pseudoHash('travel123'), channelName: 'Travel Girl', about: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ.' };
      const user3 = { id: generateId(), username: 'techlab', email: 'tech@offline.tube', passwordHash: pseudoHash('tech123'), channelName: 'Tech Lab', about: '–û–±–∑–æ—Ä—ã –≥–∞–¥–∂–µ—Ç–æ–≤ –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã.' };

      const videos = [
        {
          id: generateId(),
          title: '–ù–æ—á–Ω–æ–π —Ç–∞–π–º–ª–∞–ø—Å –≥–æ—Ä–æ–¥–∞',
          description: '–ö—Ä–∞—Å–∏–≤—ã–π —Ç–∞–π–º–ª–∞–ø—Å —Å –∫—Ä—ã—à –º–µ–≥–∞–ø–æ–ª–∏—Å–∞.',
          tags: ['–≥–æ—Ä–æ–¥', '—Ç–∞–π–º–ª–∞–ø—Å', '–Ω–æ—á—å'],
          channelId: user1.id,
          channelName: user1.channelName,
          createdAt: now - 1000 * 60 * 60 * 24 * 2,
          views: 1520,
          duration: '8:24',
          thumbnail: createThumbnail('Night City', '#2b5876', '#4e4376'),
          privacy: 'public',
          source: { type: 'url', url: '' }
        },
        {
          id: generateId(),
          title: '–ì–∞–π–¥ –ø–æ –º–æ–Ω—Ç–∞–∂—É',
          description: '–ö–∞–∫ –±—ã—Å—Ç—Ä–æ —Å–¥–µ–ª–∞—Ç—å —Å—Ç–∏–ª—å–Ω—ã–π —Ä–æ–ª–∏–∫.',
          tags: ['–º–æ–Ω—Ç–∞–∂', '–≥–∞–π–¥', '—Ç—É—Ç–æ—Ä–∏–∞–ª'],
          channelId: user3.id,
          channelName: user3.channelName,
          createdAt: now - 1000 * 60 * 60 * 24 * 5,
          views: 9540,
          duration: '12:10',
          thumbnail: createThumbnail('Edit Pro', '#314755', '#26a0da'),
          privacy: 'public',
          source: { type: 'url', url: '' }
        },
        {
          id: generateId(),
          title: '–ú–∞—Ä—à—Ä—É—Ç –ø–æ –ò—Å–ª–∞–Ω–¥–∏–∏',
          description: '–õ—É—á—à–∏–µ –ª–æ–∫–∞—Ü–∏–∏ –∑–∞ 7 –¥–Ω–µ–π.',
          tags: ['–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', '–∏—Å–ª–∞–Ω–¥–∏—è'],
          channelId: user2.id,
          channelName: user2.channelName,
          createdAt: now - 1000 * 60 * 60 * 12,
          views: 435,
          duration: '9:02',
          thumbnail: createThumbnail('Iceland', '#00c6ff', '#0072ff'),
          privacy: 'public',
          source: { type: 'url', url: '' }
        },
        {
          id: generateId(),
          title: '–£—é—Ç–Ω—ã–π –ª–æ—Ñ—Ç —Ç—É—Ä',
          description: '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –∏ —É–º–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.',
          tags: ['–¥–∏–∑–∞–π–Ω', '–¥–æ–º', '–ª–æ—Ñ—Ç'],
          channelId: user1.id,
          channelName: user1.channelName,
          createdAt: now - 1000 * 60 * 60 * 36,
          views: 3200,
          duration: '6:18',
          thumbnail: createThumbnail('Loft', '#fa709a', '#fee140'),
          privacy: 'public',
          source: { type: 'url', url: '' }
        },
        {
          id: generateId(),
          title: '–¢–µ—Ö–Ω–æ –æ–±–∑–æ—Ä: –Ω–∞—É—à–Ω–∏–∫–∏',
          description: '–†–∞–∑–±–∏—Ä–∞–µ–º –∑–≤—É–∫, –∫–æ–º—Ñ–æ—Ä—Ç –∏ –±–∞—Ç–∞—Ä–µ—é.',
          tags: ['—Ç–µ—Ö–Ω–æ', '–æ–±–∑–æ—Ä', '–Ω–∞—É—à–Ω–∏–∫–∏'],
          channelId: user3.id,
          channelName: user3.channelName,
          createdAt: now - 1000 * 60 * 60 * 80,
          views: 7780,
          duration: '10:45',
          thumbnail: createThumbnail('Headphones', '#141E30', '#243B55'),
          privacy: 'public',
          source: { type: 'url', url: '' }
        },
        {
          id: generateId(),
          title: 'Hidden beach vlog',
          description: 'Unlisted —Ä–æ–ª–∏–∫: –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –ø–ª—è–∂.',
          tags: ['vlog', '–ø–ª—è–∂'],
          channelId: user2.id,
          channelName: user2.channelName,
          createdAt: now - 1000 * 60 * 60 * 90,
          views: 120,
          duration: '4:55',
          thumbnail: createThumbnail('Beach', '#f46b45', '#eea849'),
          privacy: 'unlisted',
          source: { type: 'url', url: '' }
        }
      ];

      store.users = [user1, user2, user3];
      store.videos = videos;
      store.comments = [];
      store.likes = [];
      store.subscriptions = [{ id: generateId(), subscriberId: user1.id, channelId: user2.id }];
      store.playlists = [{ id: generateId(), userId: user1.id, name: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', description: '–õ—É—á—à–µ–µ', videoIds: [videos[0].id, videos[2].id] }];
      store.watchHistory = [];
      store.notifications = [];
      store.sessions = [];
      store.currentSessionId = null;
      saveStore();
    };

    const createThumbnail = (label, start, end) => {
      const canvas = document.createElement('canvas');
      canvas.width = 640;
      canvas.height = 360;
      const ctx = canvas.getContext('2d');
      const gradient = ctx.createLinearGradient(0, 0, 640, 360);
      gradient.addColorStop(0, start);
      gradient.addColorStop(1, end);
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'rgba(0,0,0,0.35)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 36px sans-serif';
      ctx.fillText(label, 40, 180);
      ctx.font = '16px sans-serif';
      ctx.fillText('OfflineTube', 40, 220);
      return canvas.toDataURL('image/png');
    };

    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => Array.from(document.querySelectorAll(selector));

    const state = {
      currentRoute: 'home',
      currentVideoId: null,
      homeCursor: 0,
      homeChunk: 6,
      searchQuery: ''
    };

    const currentUser = () => {
      const session = store.sessions.find(s => s.id === store.currentSessionId);
      if (!session) return null;
      return store.users.find(u => u.id === session.userId) || null;
    };

    const requireAuth = () => {
      if (!currentUser()) {
        openAuthModal();
        showToast('–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç');
        return false;
      }
      return true;
    };

    const showToast = (message) => {
      const toast = $('#toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    };

    const formatDate = (timestamp) => new Date(timestamp).toLocaleDateString('ru-RU');

    const formatViews = (views) => views.toLocaleString('ru-RU');

    const renderNav = (route) => {
      state.currentRoute = route;
      $$('.nav-link').forEach(link => link.classList.toggle('active', link.dataset.route === route));
      $$('.section').forEach(section => section.classList.toggle('active', section.id === route));
    };

    const pushRoute = (route, params = {}) => {
      const url = new URL(window.location);
      url.hash = route === 'watch' ? `watch?id=${params.id}` : route;
      window.history.pushState({ route, params }, '', url);
      openRoute(route, params);
    };

    const openRoute = (route, params = {}) => {
      renderNav(route);
      if (route === 'home') renderHome();
      if (route === 'watch') renderWatch(params.id);
      if (route === 'subscriptions') renderSubscriptions();
      if (route === 'playlists') renderPlaylists();
      if (route === 'history') renderHistory();
      if (route === 'search') renderSearch();
      if (route === 'channel') renderChannel(params.id);
    };

    const getVideoById = (id) => store.videos.find(video => video.id === id);

    const renderVideoCard = (video) => {
      const card = document.createElement('div');
      card.className = 'video-card';
      card.innerHTML = `
        <img class="video-thumb" src="${video.thumbnail}" alt="${video.title}">
        <div class="video-info">
          <strong>${video.title}</strong>
          <div class="video-meta">${video.channelName} ‚Ä¢ ${formatViews(video.views)} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ ‚Ä¢ ${formatDate(video.createdAt)}</div>
          <div class="video-meta">${video.duration} ‚Ä¢ ${video.privacy}</div>
        </div>
      `;
      card.addEventListener('click', () => pushRoute('watch', { id: video.id }));
      return card;
    };

    const getSortedVideos = (videos, mode) => {
      const copy = [...videos];
      if (mode === 'popular') {
        return copy.sort((a, b) => b.views - a.views);
      }
      return copy.sort((a, b) => b.createdAt - a.createdAt);
    };

    const getFeedVideos = () => store.videos.filter(video => video.privacy === 'public');

    const renderHome = () => {
      const sortMode = $('#home-sort').value;
      const feed = getSortedVideos(getFeedVideos(), sortMode);
      const start = 0;
      state.homeCursor = state.homeChunk;
      const grid = $('#home-grid');
      grid.innerHTML = '';
      feed.slice(start, state.homeCursor).forEach(video => grid.appendChild(renderVideoCard(video)));
      $('#home-load').classList.toggle('hidden', state.homeCursor >= feed.length);
    };

    const loadMoreHome = () => {
      const sortMode = $('#home-sort').value;
      const feed = getSortedVideos(getFeedVideos(), sortMode);
      const grid = $('#home-grid');
      const next = feed.slice(state.homeCursor, state.homeCursor + state.homeChunk);
      next.forEach(video => grid.appendChild(renderVideoCard(video)));
      state.homeCursor += state.homeChunk;
      $('#home-load').classList.toggle('hidden', state.homeCursor >= feed.length);
    };

    const renderPlayer = (video) => {
      const box = $('#player-box');
      box.innerHTML = `
        <h2>${video.title}</h2>
        <div class="muted">${video.channelName} ‚Ä¢ ${formatViews(video.views)} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ ‚Ä¢ ${formatDate(video.createdAt)}</div>
        <div style="margin:12px 0;">
          ${renderVideoSource(video)}
        </div>
        <div class="player-actions">
          <button class="btn" id="like-btn">üëç –õ–∞–π–∫ (<span id="like-count">${countLikes(video.id)}</span>)</button>
          <button class="btn" id="watch-later">‚è∞ –°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∑–∂–µ</button>
          <button class="btn" id="add-playlist">‚ûï –í –ø–ª–µ–π–ª–∏—Å—Ç</button>
          <button class="btn" id="share-btn">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
          <button class="btn" id="open-channel">üì∫ –ö–∞–Ω–∞–ª</button>
        </div>
        <p style="margin-top:12px;">${video.description}</p>
        <div class="muted">–¢–µ–≥–∏: ${video.tags.map(tag => `#${tag}`).join(' ')}</div>
      `;

      $('#like-btn').addEventListener('click', () => toggleLike(video.id));
      $('#add-playlist').addEventListener('click', () => addVideoToPlaylist(video.id));
      $('#share-btn').addEventListener('click', () => {
        const link = `${location.origin}${location.pathname}#watch?id=${video.id}`;
        navigator.clipboard?.writeText(link).then(() => showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞')).catch(() => showToast('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é'));
      });
      $('#watch-later').addEventListener('click', () => addToWatchLater(video.id));
      $('#open-channel').addEventListener('click', () => pushRoute('channel', { id: video.channelId }));
    };

    const renderVideoSource = (video) => {
      if (video.source.type === 'file' && inMemoryVideoUrls.has(video.id)) {
        return `<video controls src="${inMemoryVideoUrls.get(video.id)}"></video>`;
      }
      if (video.source.type === 'url' && video.source.url) {
        return `<video controls src="${video.source.url}"></video>`;
      }
      return `<div class="pill">–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>`;
    };

    const countLikes = (videoId) => store.likes.filter(like => like.videoId === videoId).length;

    const toggleLike = (videoId) => {
      if (!requireAuth()) return;
      const user = currentUser();
      const existing = store.likes.find(like => like.videoId === videoId && like.userId === user.id);
      if (existing) {
        store.likes = store.likes.filter(like => like !== existing);
      } else {
        store.likes.push({ id: generateId(), videoId, userId: user.id, createdAt: Date.now() });
      }
      saveStore();
      $('#like-count').textContent = countLikes(videoId);
    };

    const addToWatchLater = (videoId) => {
      if (!requireAuth()) return;
      const user = currentUser();
      let playlist = store.playlists.find(list => list.userId === user.id && list.name === '–°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∑–∂–µ');
      if (!playlist) {
        playlist = { id: generateId(), userId: user.id, name: '–°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∑–∂–µ', description: '', videoIds: [] };
        store.playlists.push(playlist);
      }
      if (!playlist.videoIds.includes(videoId)) {
        playlist.videoIds.push(videoId);
        saveStore();
        showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∑–∂–µ');
      }
    };

    const renderComments = (videoId) => {
      const sort = $('#comment-sort').value;
      const comments = store.comments.filter(comment => comment.videoId === videoId && !comment.parentId);
      const sorted = [...comments].sort((a, b) => sort === 'top' ? b.likes - a.likes : b.createdAt - a.createdAt);
      const container = $('#comment-list');
      container.innerHTML = '';
      sorted.forEach(comment => {
        const user = store.users.find(u => u.id === comment.userId);
        const replies = store.comments.filter(reply => reply.parentId === comment.id);
        const node = document.createElement('div');
        node.className = 'comment';
        node.innerHTML = `
          <strong>${user ? user.username : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong>
          <div>${comment.text}</div>
          <div class="meta">${formatDate(comment.createdAt)} ‚Ä¢ üëç ${comment.likes}</div>
          <div class="comment-actions">
            <button class="btn ghost" data-reply="${comment.id}">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
            <button class="btn ghost" data-like-comment="${comment.id}">üëç</button>
          </div>
          <div class="comment-replies"></div>
        `;
        const repliesBox = node.querySelector('.comment-replies');
        replies.forEach(reply => {
          const replyUser = store.users.find(u => u.id === reply.userId);
          const replyNode = document.createElement('div');
          replyNode.className = 'comment';
          replyNode.innerHTML = `
            <strong>${replyUser ? replyUser.username : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong>
            <div>${reply.text}</div>
            <div class="meta">${formatDate(reply.createdAt)} ‚Ä¢ üëç ${reply.likes}</div>
          `;
          repliesBox.appendChild(replyNode);
        });
        container.appendChild(node);
      });

      container.querySelectorAll('[data-reply]').forEach(btn => {
        btn.addEventListener('click', () => promptReply(videoId, btn.dataset.reply));
      });
      container.querySelectorAll('[data-like-comment]').forEach(btn => {
        btn.addEventListener('click', () => likeComment(btn.dataset.likeComment));
      });
    };

    const promptReply = (videoId, parentId) => {
      if (!requireAuth()) return;
      const text = prompt('–í–∞—à –æ—Ç–≤–µ—Ç:');
      if (!text) return;
      store.comments.push({ id: generateId(), videoId, userId: currentUser().id, parentId, text, createdAt: Date.now(), likes: 0 });
      saveStore();
      renderComments(videoId);
    };

    const likeComment = (commentId) => {
      if (!requireAuth()) return;
      const comment = store.comments.find(c => c.id === commentId);
      if (comment) {
        comment.likes += 1;
        saveStore();
        renderComments(state.currentVideoId);
      }
    };

    const addComment = () => {
      if (!requireAuth()) return;
      const text = $('#comment-input').value.trim();
      if (!text) {
        showToast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        return;
      }
      store.comments.push({ id: generateId(), videoId: state.currentVideoId, userId: currentUser().id, parentId: null, text, createdAt: Date.now(), likes: 0 });
      $('#comment-input').value = '';
      saveStore();
      renderComments(state.currentVideoId);
    };

    const renderRecommendations = (video) => {
      const tags = new Set(video.tags);
      const recs = store.videos.filter(v => v.id !== video.id && (v.channelId === video.channelId || v.tags.some(tag => tags.has(tag))) && v.privacy !== 'private');
      const container = $('#recommendations');
      container.innerHTML = '';
      recs.slice(0, 6).forEach(rec => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
          <div>
            <strong>${rec.title}</strong>
            <div class="muted">${rec.channelName}</div>
          </div>
          <button class="btn">–°–º–æ—Ç—Ä–µ—Ç—å</button>
        `;
        item.querySelector('button').addEventListener('click', () => pushRoute('watch', { id: rec.id }));
        container.appendChild(item);
      });
    };

    const renderWatch = (id) => {
      const video = getVideoById(id);
      if (!video || (video.privacy === 'private' && video.channelId !== currentUser()?.id)) {
        showToast('–í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
        pushRoute('home');
        return;
      }
      state.currentVideoId = id;
      video.views += 1;
      updateHistory(video.id);
      saveStore();
      renderPlayer(video);
      renderComments(video.id);
      renderRecommendations(video);
    };

    const updateHistory = (videoId) => {
      const user = currentUser();
      if (!user) return;
      store.watchHistory = store.watchHistory.filter(item => !(item.userId === user.id && item.videoId === videoId));
      store.watchHistory.unshift({ id: generateId(), userId: user.id, videoId, watchedAt: Date.now() });
      saveStore();
    };

    const renderSubscriptions = () => {
      const user = currentUser();
      if (!user) {
        $('#subscriptions-grid').innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏.</div>';
        return;
      }
      const subscribed = store.subscriptions.filter(sub => sub.subscriberId === user.id).map(sub => sub.channelId);
      const videos = store.videos.filter(video => subscribed.includes(video.channelId) && video.privacy !== 'private');
      const grid = $('#subscriptions-grid');
      grid.innerHTML = '';
      videos.forEach(video => grid.appendChild(renderVideoCard(video)));
    };

    const renderPlaylists = () => {
      const user = currentUser();
      const list = $('#playlist-list');
      list.innerHTML = '';
      if (!user) {
        list.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç–∞–º–∏.</div>';
        return;
      }
      store.playlists.filter(pl => pl.userId === user.id).forEach(pl => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
          <div>
            <strong>${pl.name}</strong>
            <div class="muted">${pl.description}</div>
          </div>
          <button class="btn">–û—Ç–∫—Ä—ã—Ç—å</button>
        `;
        item.querySelector('button').addEventListener('click', () => openPlaylist(pl.id));
        list.appendChild(item);
      });
    };

    const openPlaylist = (playlistId) => {
      const playlist = store.playlists.find(pl => pl.id === playlistId);
      if (!playlist) return;
      const videos = playlist.videoIds.map(getVideoById).filter(Boolean);
      const container = document.createElement('div');
      container.className = 'list';
      videos.forEach(video => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
          <div>
            <strong>${video.title}</strong>
            <div class="muted">${video.channelName}</div>
          </div>
          <div>
            <button class="btn" data-watch>‚ñ∂ –°–º–æ—Ç—Ä–µ—Ç—å</button>
            <button class="btn" data-remove>–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        item.querySelector('[data-watch]').addEventListener('click', () => pushRoute('watch', { id: video.id }));
        item.querySelector('[data-remove]').addEventListener('click', () => removeFromPlaylist(playlist.id, video.id));
        container.appendChild(item);
      });
      $('#playlist-list').innerHTML = `
        <div class="list-item">
          <div>
            <strong>${playlist.name}</strong>
            <div class="muted">${playlist.description}</div>
          </div>
          <button class="btn" id="playlist-back">–ù–∞–∑–∞–¥</button>
        </div>
      `;
      $('#playlist-list').appendChild(container);
      $('#playlist-back').addEventListener('click', renderPlaylists);
    };

    const removeFromPlaylist = (playlistId, videoId) => {
      const playlist = store.playlists.find(pl => pl.id === playlistId);
      if (!playlist) return;
      playlist.videoIds = playlist.videoIds.filter(id => id !== videoId);
      saveStore();
      openPlaylist(playlistId);
    };

    const renderHistory = () => {
      const user = currentUser();
      const list = $('#history-list');
      list.innerHTML = '';
      if (!user) {
        list.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</div>';
        return;
      }
      store.watchHistory.filter(item => item.userId === user.id).forEach(item => {
        const video = getVideoById(item.videoId);
        if (!video) return;
        const row = document.createElement('div');
        row.className = 'list-item';
        row.innerHTML = `
          <div>
            <strong>${video.title}</strong>
            <div class="muted">${formatDate(item.watchedAt)}</div>
          </div>
          <button class="btn">–°–º–æ—Ç—Ä–µ—Ç—å</button>
        `;
        row.querySelector('button').addEventListener('click', () => pushRoute('watch', { id: video.id }));
        list.appendChild(row);
      });
    };

    const renderSearch = () => {
      const query = state.searchQuery.toLowerCase();
      const dateFilter = $('#search-date').value;
      const sort = $('#search-sort').value;
      const now = Date.now();
      let results = store.videos.filter(video => {
        const text = `${video.title} ${video.description} ${video.tags.join(' ')} ${video.channelName}`.toLowerCase();
        const matches = text.includes(query);
        if (!matches) return false;
        if (video.privacy === 'private') return false;
        if (dateFilter !== 'all') {
          const days = parseInt(dateFilter, 10);
          return (now - video.createdAt) <= days * 24 * 60 * 60 * 1000;
        }
        return true;
      });

      if (sort === 'new') {
        results = results.sort((a, b) => b.createdAt - a.createdAt);
      } else if (sort === 'popular') {
        results = results.sort((a, b) => b.views - a.views);
      } else {
        results = results.sort((a, b) => b.views + b.createdAt - (a.views + a.createdAt));
      }

      const grid = $('#search-grid');
      grid.innerHTML = '';
      results.forEach(video => grid.appendChild(renderVideoCard(video)));
    };

    const renderChannel = (channelId) => {
      const channel = store.users.find(user => user.id === channelId);
      if (!channel) return;
      const hero = $('#channel-hero');
      const user = currentUser();
      const isSubscribed = user && store.subscriptions.some(sub => sub.subscriberId === user.id && sub.channelId === channelId);
      hero.dataset.channelId = channelId;
      hero.innerHTML = `
        <div>
          <h2>${channel.channelName}</h2>
          <div class="muted">@${channel.username}</div>
          <div>${channel.about || '–û–ø–∏—Å–∞–Ω–∏—è –ø–æ–∫–∞ –Ω–µ—Ç.'}</div>
        </div>
        <button class="btn" id="subscribe-btn">${isSubscribed ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}</button>
      `;
      $('#subscribe-btn').addEventListener('click', () => toggleSubscription(channelId));

      const activeTab = $('.tab.active')?.dataset.tab || 'videos';
      renderChannelTab(channelId, activeTab);
    };

    const renderChannelTab = (channelId, tab) => {
      const content = $('#channel-content');
      content.innerHTML = '';
      if (tab === 'videos') {
        const videos = store.videos.filter(video => video.channelId === channelId && video.privacy !== 'private');
        const grid = document.createElement('div');
        grid.className = 'video-grid';
        videos.forEach(video => grid.appendChild(renderVideoCard(video)));
        content.appendChild(grid);
      }
      if (tab === 'playlists') {
        const playlists = store.playlists.filter(pl => pl.userId === channelId);
        playlists.forEach(pl => {
          const item = document.createElement('div');
          item.className = 'list-item';
          item.innerHTML = `
            <div>
              <strong>${pl.name}</strong>
              <div class="muted">${pl.description}</div>
            </div>
            <button class="btn">–û—Ç–∫—Ä—ã—Ç—å</button>
          `;
          item.querySelector('button').addEventListener('click', () => openPlaylist(pl.id));
          content.appendChild(item);
        });
      }
      if (tab === 'about') {
        const channel = store.users.find(user => user.id === channelId);
        content.innerHTML = `<div class="list-item">${channel?.about || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.'}</div>`;
      }
    };

    const toggleSubscription = (channelId) => {
      if (!requireAuth()) return;
      const user = currentUser();
      const existing = store.subscriptions.find(sub => sub.subscriberId === user.id && sub.channelId === channelId);
      if (existing) {
        store.subscriptions = store.subscriptions.filter(sub => sub !== existing);
        showToast('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
      } else {
        store.subscriptions.push({ id: generateId(), subscriberId: user.id, channelId });
        showToast('–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å');
      }
      saveStore();
      renderChannel(channelId);
    };

    const updateAuthUI = () => {
      const user = currentUser();
      const button = $('#auth-btn');
      if (user) {
        button.textContent = `@${user.username}`;
      } else {
        button.textContent = '–í–æ–π—Ç–∏';
      }
      updateNotifications();
    };

    const openAuthModal = () => {
      $('#auth-modal').classList.add('active');
      $('#auth-email').parentElement.style.display = authMode === 'register' ? 'grid' : 'none';
      $('#auth-title').textContent = authMode === 'register' ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í—Ö–æ–¥';
      $('#auth-submit').textContent = authMode === 'register' ? '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' : '–í–æ–π—Ç–∏';
    };

    let authMode = 'login';

    const toggleAuthMode = () => {
      authMode = authMode === 'login' ? 'register' : 'login';
      openAuthModal();
    };

    const submitAuth = () => {
      const username = $('#auth-username').value.trim();
      const email = $('#auth-email').value.trim();
      const password = $('#auth-password').value.trim();
      if (authMode === 'register') {
        if (!username || !email || !password) {
          showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
          return;
        }
        if (store.users.some(user => user.username === username || user.email === email)) {
          showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
          return;
        }
        const user = { id: generateId(), username, email, passwordHash: pseudoHash(password), channelName: username, about: '' };
        store.users.push(user);
        showToast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω');
      }
      const found = store.users.find(user => user.username === username && user.passwordHash === pseudoHash(password));
      if (!found) {
        showToast('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
        return;
      }
      const session = { id: generateId(), userId: found.id, createdAt: Date.now() };
      store.sessions.push(session);
      store.currentSessionId = session.id;
      saveStore();
      $('#auth-modal').classList.remove('active');
      updateAuthUI();
      renderSubscriptions();
      renderPlaylists();
      renderHistory();
    };

    const logout = () => {
      store.currentSessionId = null;
      saveStore();
      updateAuthUI();
      showToast('–í—ã –≤—ã—à–ª–∏');
    };

    const openUploadModal = () => {
      if (!requireAuth()) return;
      $('#upload-modal').classList.add('active');
    };

    const submitUpload = () => {
      if (!requireAuth()) return;
      const title = $('#upload-title').value.trim();
      const description = $('#upload-description').value.trim();
      const tags = $('#upload-tags').value.split(',').map(tag => tag.trim()).filter(Boolean);
      const privacy = $('#upload-privacy').value;
      const file = $('#upload-file').files[0];
      const url = $('#upload-url').value.trim();
      if (!title || (!file && !url)) {
        showToast('–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ñ–∞–π–ª/—Å—Å—ã–ª–∫—É');
        return;
      }
      const user = currentUser();
      const videoId = generateId();
      if (file) {
        const objectUrl = URL.createObjectURL(file);
        inMemoryVideoUrls.set(videoId, objectUrl);
      }
      const video = {
        id: videoId,
        title,
        description,
        tags,
        channelId: user.id,
        channelName: user.channelName,
        createdAt: Date.now(),
        views: 0,
        duration: file ? '–í–∏–¥–µ–æ' : '–°—Å—ã–ª–∫–∞',
        thumbnail: createThumbnail(title.slice(0, 12), '#4b6cb7', '#182848'),
        privacy,
        source: { type: file ? 'file' : 'url', url: url || '' }
      };
      store.videos.unshift(video);
      notifySubscribers(video);
      saveStore();
      $('#upload-modal').classList.remove('active');
      clearUploadForm();
      renderHome();
      showToast('–í–∏–¥–µ–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
    };

    const clearUploadForm = () => {
      $('#upload-title').value = '';
      $('#upload-description').value = '';
      $('#upload-tags').value = '';
      $('#upload-privacy').value = 'public';
      $('#upload-file').value = '';
      $('#upload-url').value = '';
    };

    const notifySubscribers = (video) => {
      const subs = store.subscriptions.filter(sub => sub.channelId === video.channelId);
      subs.forEach(sub => {
        store.notifications.push({
          id: generateId(),
          userId: sub.subscriberId,
          text: `–ù–æ–≤–æ–µ –≤–∏–¥–µ–æ –æ—Ç ${video.channelName}: ${video.title}`,
          createdAt: Date.now(),
          videoId: video.id,
          read: false
        });
      });
    };

    const updateNotifications = () => {
      const user = currentUser();
      const count = $('#notif-count');
      if (!user) {
        count.classList.add('hidden');
        return;
      }
      const unread = store.notifications.filter(notif => notif.userId === user.id && !notif.read);
      count.textContent = unread.length;
      count.classList.toggle('hidden', unread.length === 0);
    };

    const openNotifications = () => {
      if (!requireAuth()) return;
      const user = currentUser();
      const list = $('#notifications-list');
      list.innerHTML = '';
      const userNotifs = store.notifications.filter(notif => notif.userId === user.id).sort((a, b) => b.createdAt - a.createdAt);
      userNotifs.forEach(notif => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
          <div>
            <strong>${notif.text}</strong>
            <div class="muted">${formatDate(notif.createdAt)}</div>
          </div>
          <button class="btn">–°–º–æ—Ç—Ä–µ—Ç—å</button>
        `;
        item.querySelector('button').addEventListener('click', () => {
          notif.read = true;
          saveStore();
          $('#notifications-modal').classList.remove('active');
          pushRoute('watch', { id: notif.videoId });
        });
        list.appendChild(item);
        notif.read = true;
      });
      saveStore();
      $('#notifications-modal').classList.add('active');
      updateNotifications();
    };

    const createPlaylist = () => {
      if (!requireAuth()) return;
      const name = $('#playlist-name').value.trim();
      const description = $('#playlist-description').value.trim();
      if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
        return;
      }
      store.playlists.push({ id: generateId(), userId: currentUser().id, name, description, videoIds: [] });
      saveStore();
      $('#playlist-modal').classList.remove('active');
      $('#playlist-name').value = '';
      $('#playlist-description').value = '';
      renderPlaylists();
    };

    const addVideoToPlaylist = (videoId) => {
      if (!requireAuth()) return;
      const playlists = store.playlists.filter(pl => pl.userId === currentUser().id);
      const name = prompt(`–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–µ–π–ª–∏—Å—Ç: ${playlists.map(pl => pl.name).join(', ')}`);
      const playlist = playlists.find(pl => pl.name === name);
      if (!playlist) return;
      if (!playlist.videoIds.includes(videoId)) {
        playlist.videoIds.push(videoId);
        saveStore();
        showToast('–í–∏–¥–µ–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–ª–µ–π–ª–∏—Å—Ç');
      }
    };

    const handleHistoryClear = () => {
      if (!requireAuth()) return;
      const user = currentUser();
      store.watchHistory = store.watchHistory.filter(item => item.userId !== user.id);
      saveStore();
      renderHistory();
      showToast('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
    };

    const handleSearch = () => {
      const query = $('#global-search').value.trim();
      if (!query) return;
      state.searchQuery = query;
      pushRoute('search');
      renderSearch();
    };

    const initEvents = () => {
      $$('.nav-link').forEach(link => link.addEventListener('click', () => pushRoute(link.dataset.route)));
      $('#home-sort').addEventListener('change', renderHome);
      $('#home-load').addEventListener('click', loadMoreHome);
      $('#comment-submit').addEventListener('click', addComment);
      $('#comment-sort').addEventListener('change', () => renderComments(state.currentVideoId));
      $('#auth-btn').addEventListener('click', () => {
        if (currentUser()) {
          if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) logout();
        } else {
          openAuthModal();
        }
      });
      $('#auth-toggle').addEventListener('click', toggleAuthMode);
      $('#auth-submit').addEventListener('click', submitAuth);
      $('#upload-btn').addEventListener('click', openUploadModal);
      $('#upload-cancel').addEventListener('click', () => $('#upload-modal').classList.remove('active'));
      $('#upload-submit').addEventListener('click', submitUpload);
      $('#playlist-create').addEventListener('click', () => $('#playlist-modal').classList.add('active'));
      $('#playlist-cancel').addEventListener('click', () => $('#playlist-modal').classList.remove('active'));
      $('#playlist-submit').addEventListener('click', createPlaylist);
      $('#history-clear').addEventListener('click', handleHistoryClear);
      $('#search-btn').addEventListener('click', handleSearch);
      $('#global-search').addEventListener('keydown', (event) => {
        if (event.key === 'Enter') handleSearch();
      });
      $('#search-date').addEventListener('change', renderSearch);
      $('#search-sort').addEventListener('change', renderSearch);
      $('#notifications-btn').addEventListener('click', openNotifications);
      $('#notifications-close').addEventListener('click', () => $('#notifications-modal').classList.remove('active'));
      $$('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          $$('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const channelId = $('#channel-hero').dataset.channelId;
          renderChannelTab(channelId, tab.dataset.tab);
        });
      });
      window.addEventListener('hashchange', handleHashRoute);
      window.addEventListener('popstate', (event) => {
        if (event.state?.route) {
          openRoute(event.state.route, event.state.params || {});
        }
      });
      document.body.addEventListener('click', (event) => {
        if (event.target.matches('.video-card')) return;
        if (event.target.matches('.modal')) event.target.classList.remove('active');
      });
      $('#player-box').addEventListener('dblclick', () => addVideoToPlaylist(state.currentVideoId));
    };

    const handleHashRoute = () => {
      const hash = window.location.hash.replace('#', '');
      if (hash.startsWith('watch')) {
        const params = new URLSearchParams(hash.split('?')[1]);
        const id = params.get('id');
        if (id) {
          openRoute('watch', { id });
          return;
        }
      }
      if (hash) {
        openRoute(hash);
      }
    };

    loadStore();
    updateAuthUI();
    initEvents();
    renderHome();
    handleHashRoute();
  </script>
</body>
</html>
